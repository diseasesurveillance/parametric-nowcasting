---
title: "Fitting example of cumulative reporting probability"
prerequisites:
    - data/processed/huso104_20110512_20110606.rds
    - data/processed/sari_41002_20090614_20091122.rds
targets:
    - data/figures/qd_example_sari_huso104.png
---



<p>We show an example of how the exponential and Gompertz cumulative reporting probability
fits real data.</p>
<div id="load-packages-scripts-and-data" class="section level2">
<h2>Load packages, scripts and data</h2>
<pre class="r"><code>library(dplyr)</code></pre>
<pre><code>#&gt; 
#&gt; Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>#&gt; The following objects are masked from &#39;package:stats&#39;:
#&gt; 
#&gt;     filter, lag</code></pre>
<pre><code>#&gt; The following objects are masked from &#39;package:base&#39;:
#&gt; 
#&gt;     intersect, setdiff, setequal, union</code></pre>
<pre class="r"><code>library(tidyr)
library(ggplot2)
library(latex2exp)

path_proj &lt;- here::here()
path_src &lt;- file.path(path_proj, &quot;src&quot;)
path_data &lt;- file.path(path_proj, &quot;data&quot;)
path_cleaned &lt;- file.path(path_data, &quot;cleaned&quot;)
path_processed &lt;- file.path(path_data, &quot;processed&quot;)
path_figures &lt;- file.path(path_data, &quot;figures&quot;)

source(file.path(path_src, &quot;20-processing.R&quot;))
source(file.path(path_src, &quot;30-eda.R&quot;))

huso &lt;- readRDS(file.path(path_processed, &quot;huso104_20110512_20110606.rds&quot;))
sari &lt;- readRDS(file.path(path_processed, &quot;sari_41002_20090614_20091122.rds&quot;))</code></pre>
</div>
<div id="convert-to-long-format-and-filter" class="section level2">
<h2>Convert to long format and filter</h2>
<p>Convert datasets to long format and filter the desired date: <code>2009-08-30</code> for SARI, and <code>2011-05-22</code> for HusO104.</p>
<pre class="r"><code>sari_train &lt;- sari |&gt;
    select(-cases_baseline) |&gt;
    reporcases_longer() |&gt;
    filter(date == &quot;2009-08-30&quot;)

huso_train &lt;- huso |&gt;
    select(-cases_baseline) |&gt;
    reporcases_longer() |&gt;
    filter(date == &quot;2011-05-22&quot;)</code></pre>
</div>
<div id="fit-exponential-model-for-sari" class="section level2">
<h2>Fit exponential model for SARI</h2>
<pre class="r"><code>sari_model &lt;- nls(
    cases ~ exp(logN) * (1 - (1 - plogis(logitphi))* exp(-b * delay)),
    data = sari_train,
    start = list(b = 0.5, logitphi = qlogis(0.5), logN = log(max(sari_train$cases)))
)
sari_model</code></pre>
<pre><code>#&gt; Nonlinear regression model
#&gt;   model: cases ~ exp(logN) * (1 - (1 - plogis(logitphi)) * exp(-b * delay))
#&gt;    data: sari_train
#&gt;        b logitphi     logN 
#&gt;   0.2096  -1.3486   6.6710 
#&gt;  residual sum-of-squares: 3527
#&gt; 
#&gt; Number of iterations to convergence: 5 
#&gt; Achieved convergence tolerance: 3.086e-06</code></pre>
<pre class="r"><code>sari_train &lt;- sari_train |&gt;
    mutate(q = cases / exp(coef(sari_model)[&quot;logN&quot;]))

sari_fit &lt;- data.frame(delay = seq(0, 26, length = 100)) |&gt;
    mutate(q = qexp(plogis(coef(sari_model)[&quot;logitphi&quot;]), coef(sari_model)[&quot;b&quot;])(delay))</code></pre>
</div>
<div id="fit-gompertz-model-for-huso104" class="section level2">
<h2>Fit Gompertz model for HusO104</h2>
<pre class="r"><code>huso_model &lt;- nls(
    cases ~ exp(logN) * exp(logphi*exp(-b * delay)),
    data = huso_train,
    start = list(b = 0.5, logphi = log(0.05), logN = log(max(huso_train$cases)))
)
huso_model</code></pre>
<pre><code>#&gt; Nonlinear regression model
#&gt;   model: cases ~ exp(logN) * exp(logphi * exp(-b * delay))
#&gt;    data: huso_train
#&gt;      b logphi   logN 
#&gt;  0.352 -5.391  3.764 
#&gt;  residual sum-of-squares: 72.88
#&gt; 
#&gt; Number of iterations to convergence: 7 
#&gt; Achieved convergence tolerance: 7.918e-06</code></pre>
<pre class="r"><code>huso_train &lt;- huso_train |&gt;
    mutate(q = cases / exp(coef(huso_model)[&quot;logN&quot;]))

huso_fit &lt;- data.frame(delay = seq(0, 15, length = 100)) |&gt;
    mutate(q = qgom(exp(coef(huso_model)[&quot;logphi&quot;]), coef(huso_model)[&quot;b&quot;])(delay))</code></pre>
</div>
<div id="visualize-theoretical-and-empirical-curves-for-sari-and-huso104" class="section level2">
<h2>Visualize theoretical and empirical curves for SARI and HusO104</h2>
<pre class="r"><code>df_train &lt;- bind_rows(list(exp = sari_train, gomp = huso_train), .id = &quot;model&quot;)
df_fit &lt;- bind_rows(list(exp = sari_fit, gomp = huso_fit), .id = &quot;model&quot;)

mylabs &lt;- c(&quot;exp&quot; = &quot;(a) SARI: Exponential&quot;, &quot;gomp&quot; = &quot;(b) HUS-O104: Gompertz&quot;)
p &lt;- plot_compare_curves(df_train, df_fit, mylabs) +
    scale_y_continuous(limits = c(0, 1))</code></pre>
<pre><code>#&gt; Scale for y is already present.
#&gt; Adding another scale for y, which will replace the existing scale.</code></pre>
<pre class="r"><code>p</code></pre>
<p><img src="/parametric-nowcasting/40-explore/28-example-reporting-probability_files/figure-html/unnamed-chunk-5-1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggsave(file.path(path_figures, &quot;qd_example_sari_huso104.png&quot;), p,
      width = 20 * 8/ 20, height = 8 * 8 / 20, dpi = 300)</code></pre>
</div>
<div id="time-to-execute-the-task" class="section level2">
<h2>Time to execute the task</h2>
<p>Only useful when executed with <code>Rscript</code>.</p>
<pre class="r"><code>proc.time()</code></pre>
<pre><code>#&gt;    user  system elapsed 
#&gt;   1.190   0.337   1.210</code></pre>
</div>
