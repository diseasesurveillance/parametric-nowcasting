---
title: "HusO104: Compare growth curves"
prerequisites:
    - data/processed/huso104_20110512_20110606.rds
targets:
    - data/figures/huso104_qd_comparison.png
---



<div id="load-packages-scripts-and-data" class="section level2">
<h2>Load packages, scripts and data</h2>
<pre class="r"><code>library(dplyr)</code></pre>
<pre><code>#&gt; 
#&gt; Attaching package: &#39;dplyr&#39;</code></pre>
<pre><code>#&gt; The following objects are masked from &#39;package:stats&#39;:
#&gt; 
#&gt;     filter, lag</code></pre>
<pre><code>#&gt; The following objects are masked from &#39;package:base&#39;:
#&gt; 
#&gt;     intersect, setdiff, setequal, union</code></pre>
<pre class="r"><code>library(tidyr)
library(ggplot2)
library(latex2exp)

path_proj &lt;- here::here()
path_src &lt;- file.path(path_proj, &quot;src&quot;)
path_data &lt;- file.path(path_proj, &quot;data&quot;)
path_cleaned &lt;- file.path(path_data, &quot;cleaned&quot;)
path_processed &lt;- file.path(path_data, &quot;processed&quot;)
path_figures &lt;- file.path(path_data, &quot;figures&quot;)

source(file.path(path_src, &quot;20-processing.R&quot;))
source(file.path(path_src, &quot;30-eda.R&quot;))

huso &lt;- readRDS(file.path(path_processed, &quot;huso104_20110512_20110606.rds&quot;))</code></pre>
</div>
<div id="convert-to-long-format" class="section level2">
<h2>Convert to long format</h2>
<p>Convert data to long format and filter with observed data by the last available date.</p>
<pre class="r"><code>huso_long &lt;- huso |&gt;
    select(-cases_baseline) |&gt;
    mutate(available_delay = seq(n()-1, 0)) |&gt;
    reporcases_longer() |&gt;
    filter(delay &lt;= available_delay)</code></pre>
</div>
<div id="fit-exponential-and-gompertz-curves" class="section level2">
<h2>Fit Exponential and Gompertz curves</h2>
<p>We will compare the exponential and Gompertz growth curves assuming a time-invariant
reporting probability in the period of time between <code>2009-07-19</code> and <code>2009-09-06</code>.</p>
<pre class="r"><code># prepare the data to train
somedates &lt;- seq(as.Date(&quot;2011-05-20&quot;), as.Date(&quot;2011-05-27&quot;), &quot;1 day&quot;)
df_train &lt;- filter(huso_long, date %in% somedates) |&gt;
    mutate(date = factor(date))
df_fit &lt;- data.frame(delay = seq(0, max(df_train$delay), length = 100))

# initial values
max_cases &lt;- group_by(df_train, date) |&gt;
    summarise(cases = max(cases)) |&gt;
    pull(cases)

# fit models
mod_gomp &lt;- nls(
    cases ~ exp(logN[date]) * exp(logphi*exp(-b * delay)),
    data = df_train,
    start = list(b = 0.5, logphi = log(0.05), logN = log(max_cases))
)
mod_gomp</code></pre>
<pre><code>#&gt; Nonlinear regression model
#&gt;   model: cases ~ exp(logN[date]) * exp(logphi * exp(-b * delay))
#&gt;    data: df_train
#&gt;       b  logphi   logN1   logN2   logN3   logN4   logN5   logN6   logN7   logN8 
#&gt;  0.3302 -4.4608  3.4006  4.0993  3.7603  3.5291  3.8183  3.7159  3.5416  3.4275 
#&gt;  residual sum-of-squares: 1035
#&gt; 
#&gt; Number of iterations to convergence: 7 
#&gt; Achieved convergence tolerance: 2.762e-06</code></pre>
<pre class="r"><code>mod_exp &lt;- nls(
    cases ~ exp(logN[date]) * (1 - exp(-b * delay)),
    data = df_train,
    start = list(b = 0.5, logN = log(max_cases))
)
mod_exp</code></pre>
<pre><code>#&gt; Nonlinear regression model
#&gt;   model: cases ~ exp(logN[date]) * (1 - exp(-b * delay))
#&gt;    data: df_train
#&gt;       b   logN1   logN2   logN3   logN4   logN5   logN6   logN7   logN8 
#&gt; 0.04132 4.24191 4.93657 4.59965 4.39141 4.69686 4.60684 4.44220 4.32496 
#&gt;  residual sum-of-squares: 1481
#&gt; 
#&gt; Number of iterations to convergence: 10 
#&gt; Achieved convergence tolerance: 2.828e-06</code></pre>
<pre class="r"><code># summarise
list(Exponential = mod_exp, Gompertz = mod_gomp) |&gt;
    sapply(function(x) c(AIC = AIC(x), BIC = BIC(x), SSE = deviance(x))) |&gt;
    data.frame()</code></pre>
<pre><code>#&gt;     Exponential  Gompertz
#&gt; AIC    631.4156  592.9796
#&gt; BIC    658.6895  622.9809
#&gt; SSE   1480.6971 1035.2804</code></pre>
</div>
<div id="visualize-standardised-fitted-curves" class="section level2">
<h2>Visualize standardised fitted curves</h2>
<p>Letâ€™s obtain the curves with the estimated parameter for each model.</p>
<pre class="r"><code>logns &lt;- paste0(&quot;logN&quot;, 1:nlevels(df_train$date))

# predict
df_train &lt;- df_train |&gt;
    mutate(gomp_total = exp(coef(mod_gomp)[logns])[date], gomp_q = cases / gomp_total,
           exp_total = exp(coef(mod_exp)[logns])[date], exp_q = cases / exp_total) |&gt;
    pivot_longer(gomp_total:exp_q, names_to = c(&quot;model&quot;, &quot;var&quot;),
                 names_pattern = &quot;(.*)_(.*)&quot;) |&gt;
    pivot_wider(names_from = var, values_from = value)

df_fit &lt;- df_fit |&gt;
    mutate(gomp_q = qgom(exp(coef(mod_gomp)[&quot;logphi&quot;]), coef(mod_gomp)[&quot;b&quot;])(delay),
           exp_q = qexp(0, coef(mod_exp)[&quot;b&quot;])(delay)) |&gt;
    pivot_longer(gomp_q:exp_q, names_to = c(&quot;model&quot;), values_to = &quot;q&quot;,
                 names_transform = function(x) sub(&quot;_q&quot;, &quot;&quot;, x))</code></pre>
<p>Visualize the estimated theoretical curves using the exponential and Gompertz models.</p>
<pre class="r"><code>mylabs &lt;- c(&quot;exp&quot; = &quot;(a) Exponential&quot;, &quot;gomp&quot; = &quot;(b) Gompertz&quot;)
p &lt;- plot_compare_curves(df_train, df_fit, mylabs)
p</code></pre>
<p><img src="/parametric-nowcasting/40-explore/24-husO104-compare-curves_files/figure-html/unnamed-chunk-5-1.png" width="100%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>ggsave(file.path(path_figures, &quot;huso104_qd_comparison.png&quot;), p,
      width = 20 * 8/ 20, height = 8 * 8 / 20, dpi = 300)</code></pre>
</div>
<div id="time-to-execute-the-task" class="section level2">
<h2>Time to execute the task</h2>
<p>Only useful when executed with <code>Rscript</code>.</p>
<pre class="r"><code>proc.time()</code></pre>
<pre><code>#&gt;    user  system elapsed 
#&gt;   1.138   0.315   1.136</code></pre>
</div>
